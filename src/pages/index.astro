---
import BaseLayout from '../layouts/BaseLayout.astro';
import Footer from '../components/Footer.astro';

const GOOGLE_CLIENT_ID = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID;
---

<BaseLayout title="Iniciar Sesión - SEDI">
  <div class="flex flex-col min-h-screen bg-gray-100">
    <header class="bg-[#3d3d3d] text-white px-4 py-6 sm:px-8 border-b-4 border-[#8b7355] text-center">
      <div class="max-w-screen-xl mx-auto">
        <h1 class="text-base sm:text-xl font-bold tracking-wide leading-snug m-0">
          UNIVERSIDAD AUTÓNOMA DE BAJA CALIFORNIA
        </h1>
        <p class="text-sm sm:text-base font-semibold mt-1 tracking-wide">
          FACULTAD DE INGENIERÍA, ARQUITECTURA Y DISEÑO
        </p>
        <p class="text-xs sm:text-sm mt-1 italic opacity-95">
          SISTEMA DE EXPEDIENTE ACADÉMICO
        </p>
      </div>
    </header>

    <main class="flex-1 flex items-center justify-center px-4 py-12 sm:px-8">
      <div class="flex flex-col items-center gap-6 bg-white p-8 sm:p-12 rounded-xl shadow-lg text-center max-w-lg w-full">
        <h2 class="text-3xl font-semibold text-gray-800 m-0">Iniciar sesión</h2>
        
        <div id="google-signin-button" class="w-full"></div>

        <p class="text-gray-500 text-base mt-2">Favor de iniciar sesión con su cuenta de Google</p>
        
        <div id="error-message" class="hidden text-red-600 text-sm mt-2"></div>
      </div>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script src="https://accounts.google.com/gsi/client" async></script>

<script define:vars={{ GOOGLE_CLIENT_ID }}>
  async function handleCredentialResponse(response) {
    const credential = response.credential;

    try {
      const res = await fetch('http://sedi_backend.test/api/', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        body: JSON.stringify({ id_token: credential })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
          errorDiv.textContent = data.message || data.error || 'Error al iniciar sesión';
          errorDiv.classList.remove('hidden');
        }
        return;
      }

      if (data.user) {
        if (data.token) {
          localStorage.setItem('access_token', data.token);
        }
        localStorage.setItem('user_email', data.user.correo);
        localStorage.setItem('user_name', data.user.nombre);
        localStorage.setItem('user_id', data.user.id.toString());
        localStorage.setItem('user_rol', data.user.rol);
      }

      // Pequeño delay para asegurar que localStorage se guarde
      await new Promise(resolve => setTimeout(resolve, 100));
      
      window.location.href = '/principal';

    } catch (err) {
      const errorDiv = document.getElementById('error-message');
      if (errorDiv) {
        errorDiv.textContent = 'Error al iniciar sesión. Por favor, intenta nuevamente.';
        errorDiv.classList.remove('hidden');
      }
    }
  }

  window.onload = function() {
    if (typeof google !== 'undefined') {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
      });

      google.accounts.id.renderButton(
        document.getElementById('google-signin-button'),
        { 
          theme: 'outline', 
          size: 'large',
          width: 400,
          text: 'signin_with',
          locale: 'es'
        }
      );

      google.accounts.id.prompt();
    }
  };
</script>
