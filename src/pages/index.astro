---
import BaseLayout from '../layouts/BaseLayout.astro';
import Footer from '../components/Footer.astro';

const GOOGLE_CLIENT_ID = import.meta.env.PUBLIC_GOOGLE_CLIENT_ID;
---

<BaseLayout title="Iniciar Sesión - SEDI">
  <div class="flex flex-col min-h-screen bg-gray-100">
    <header class="bg-[#3d3d3d] text-white px-4 py-6 sm:px-8 border-b-4 border-[#8b7355] text-center">
      <div class="max-w-screen-xl mx-auto">
        <h1 class="text-base sm:text-xl font-bold tracking-wide leading-snug m-0">
          UNIVERSIDAD AUTÓNOMA DE BAJA CALIFORNIA
        </h1>
        <p class="text-sm sm:text-base font-semibold mt-1 tracking-wide">
          FACULTAD DE INGENIERÍA, ARQUITECTURA Y DISEÑO
        </p>
        <p class="text-xs sm:text-sm mt-1 italic opacity-95">
          SISTEMA DE EXPEDIENTE ACADÉMICO
        </p>
      </div>
    </header>

    <main class="flex-1 flex items-center justify-center px-4 py-12 sm:px-8">
      <div class="flex flex-col items-center gap-6 bg-white p-8 sm:p-12 rounded-xl shadow-lg text-center max-w-lg w-full">
        <h2 class="text-3xl font-semibold text-gray-800 m-0">Iniciar sesión</h2>
        
        <div id="google-signin-button" class="w-full"></div>

        <p class="text-gray-500 text-base mt-2">Usa tu cuenta institucional @uabc.edu.mx para iniciar sesión</p>
        
        <div id="error-message" class="hidden text-red-600 text-sm mt-2"></div>
      </div>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script src="https://accounts.google.com/gsi/client" async></script>

<script define:vars={{ GOOGLE_CLIENT_ID }}>
  function handleCredentialResponse(response) {
    const credential = response.credential;
    
    const payload = JSON.parse(atob(credential.split('.')[1]));
    const email = payload.email;
    const name = payload.name;
    const picture = payload.picture;
    
     if (!email.endsWith('@uabc.edu.mx')) {
      const errorDiv = document.getElementById('error-message');
      if (errorDiv) {
        errorDiv.textContent = 'Solo se permiten cuentas institucionales @uabc.edu.mx';
        errorDiv.classList.remove('hidden');
      }
      return;
    }
    
    localStorage.setItem('user_email', email);
    localStorage.setItem('user_name', name);
    localStorage.setItem('user_picture', picture);
    localStorage.setItem('google_token', credential);
    localStorage.setItem('auth_timestamp', Date.now().toString());
    
    window.location.href = '/dashboard';
  }

  window.onload = function() {
    if (typeof google !== 'undefined') {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
      });
      
      google.accounts.id.renderButton(
        document.getElementById('google-signin-button'),
        { 
          theme: 'outline', 
          size: 'large',
          width: 400,
          text: 'signin_with',
          locale: 'es'
        }
      );
      
      google.accounts.id.prompt();
    }
  };
</script>
