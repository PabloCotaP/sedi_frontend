---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Sidebar from '../components/Sidebar.astro';
---

<BaseLayout title="Participación en colegios - SEDI">
  <Sidebar />

  <div class="flex flex-col min-h-screen bg-white">
    <Header showUserInfo={true} userEmail="" />

    <main class="flex-1 bg-[#f3f3f3] px-4 py-8 sm:px-8">
      <div id="vista-lista" class="max-w-[1728px] mx-auto bg-[#f3f3f3] rounded-[25px] shadow-[0px_4px_4px_0px_rgba(0,0,0,0.25)] p-6 sm:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div class="flex-1">
            <h1 class="text-[28px] sm:text-[32px] font-normal text-black mb-2 italic">
              Participación en colegios, cámaras, asociaciones científicas o algún otro tipo de organismo profesional
            </h1>
            <p class="text-[14px] text-gray-700 leading-snug">
              Membresía vigente en colegios, cámaras, asociaciones científicas o algún otro tipo de organismo profesional. Nombre del organismo, tiempo de membresía y el nivel de participación (miembro, socio, directivo, integrante o coordinador de algún equipo o comisión, etc.).
            </p>
          </div>
          <div class="flex gap-3">
            <button 
              id="btn-agregar"
              class="bg-[#1f6818] hover:bg-[#165012] text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200 whitespace-nowrap">
              Agregar
            </button>
            <a 
              href="/dashboard"
              class="bg-[#8b7355] hover:bg-[#7a6349] text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200 whitespace-nowrap">
              Regresar
            </a>
          </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-lg">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-[#d9d9d9]">
                <th class="border border-gray-400 px-4 py-3 text-left font-normal text-[20px] text-black">Organismo</th>
                <th class="border border-gray-400 px-4 py-3 text-left font-normal text-[20px] text-black">Periodo (años)</th>
                <th class="border border-gray-400 px-4 py-3 text-left font-normal text-[20px] text-black">Nivel de participación</th>
                <th class="border border-gray-400 px-4 py-3 text-center font-normal text-[20px] text-black">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-participaciones">
              <tr>
                <td colspan="4" class="border border-gray-400 px-4 py-8 text-center text-gray-500">
                  No hay registros aún. Haz clic en "Agregar" para crear uno nuevo.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="vista-formulario" class="max-w-[1728px] mx-auto bg-[#f3f3f3] rounded-[25px] shadow-[0px_4px_4px_0px_rgba(0,0,0,0.25)] p-6 sm:p-8 hidden">
        <div class="flex justify-between items-center mb-8">
          <h1 class="text-[28px] sm:text-[32px] font-bold text-black text-center flex-1 italic uppercase">
            PARTICIPACIÓN EN COLEGIOS, CÁMARAS, ASOCIACIONES CIENTÍFICAS O ALGÚN OTRO TIPO DE ORGANISMO PROFESIONAL
          </h1>
          <button 
            id="btn-regresar"
            class="bg-[#8b7355] hover:bg-[#7a6349] text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200 whitespace-nowrap">
            Regresar
          </button>
        </div>

        <form class="space-y-6 max-w-4xl mx-auto">
          <div class="flex items-center gap-6">
            <label for="organismo" class="w-48 text-right font-semibold text-black text-[18px]">
              Organismo
            </label>
            <input
              type="text"
              id="organismo"
              name="organismo"
              required
              class="flex-1 border-2 border-black rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
            />
          </div>

          <div class="flex items-center gap-6">
            <label for="periodo" class="w-48 text-right font-semibold text-black text-[18px]">
              Periodo (años)
            </label>
            <input
              type="text"
              id="periodo"
              name="periodo"
              required
              class="flex-1 border-2 border-black rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
            />
          </div>

          <div class="flex items-center gap-6">
            <label for="nivel" class="w-48 text-right font-semibold text-black text-[18px]">
              Nivel de participación
            </label>
            <input
              type="text"
              id="nivel"
              name="nivel"
              required
              class="flex-1 border-2 border-black rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
            />
          </div>

          <div class="flex justify-center pt-4">
            <label for="documento" class="cursor-pointer bg-[#d9d9d9] hover:bg-[#c0c0c0] border-2 border-black rounded-lg px-8 py-4 inline-flex items-center transition-colors duration-200 font-semibold text-[18px]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              Subir documento
            </label>
            <input
              type="file"
              id="documento"
              name="documento"
              class="hidden"
            />
          </div>

          <div class="flex justify-center pt-6">
            <button
              type="submit"
              class="bg-[#0891b2] hover:bg-[#0e7490] text-white font-semibold py-3 px-16 rounded-lg transition-colors duration-200 text-[18px]">
              Guardar
            </button>
          </div>
        </form>
      </div>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script>
  const vistaLista = document.getElementById('vista-lista');
  const vistaFormulario = document.getElementById('vista-formulario');
  const btnAgregar = document.getElementById('btn-agregar');
  const btnRegresar = document.getElementById('btn-regresar');
  const tablaParticipaciones = document.getElementById('tabla-participaciones');
  const formulario = document.querySelector('#vista-formulario form');

  let participaciones: any[] = [];
  let editandoIndex: number | null = null;

  function renderizarTabla() {
    if (!tablaParticipaciones) return;

    if (participaciones.length === 0) {
      tablaParticipaciones.innerHTML = `
        <tr>
          <td colspan="4" class="border border-gray-400 px-4 py-8 text-center text-gray-500">
            No hay registros aún. Haz clic en "Agregar" para crear uno nuevo.
          </td>
        </tr>
      `;
    } else {
      tablaParticipaciones.innerHTML = participaciones.map((item, index) => `
        <tr class="hover:bg-gray-50">
          <td class="border border-gray-400 px-4 py-3 text-black">${item.organismo}</td>
          <td class="border border-gray-400 px-4 py-3 text-black">${item.periodo}</td>
          <td class="border border-gray-400 px-4 py-3 text-black">${item.nivelParticipacion}</td>
          <td class="border border-gray-400 px-4 py-3">
            <div class="flex justify-center items-center gap-3">
              <button class="btn-ver text-gray-600 hover:text-gray-800" data-index="${index}" title="Ver">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
              <button class="btn-editar text-gray-600 hover:text-gray-800" data-index="${index}" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button class="btn-eliminar text-red-600 hover:text-red-800" data-index="${index}" title="Eliminar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');

      document.querySelectorAll('.btn-ver').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index') || '0');
          const item = participaciones[index];
          alert(`Organismo: ${item.organismo}\nPeriodo: ${item.periodo}\nNivel: ${item.nivelParticipacion}`);
        });
      });

      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index') || '0');
          editandoIndex = index;
          const item = participaciones[index];
          (document.getElementById('organismo') as HTMLInputElement).value = item.organismo;
          (document.getElementById('periodo') as HTMLInputElement).value = item.periodo;
          (document.getElementById('nivel') as HTMLInputElement).value = item.nivelParticipacion;
          vistaLista?.classList.add('hidden');
          vistaFormulario?.classList.remove('hidden');
        });
      });

      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
            const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index') || '0');
            participaciones.splice(index, 1);
            renderizarTabla();
          }
        });
      });
    }
  }

  btnAgregar?.addEventListener('click', () => {
    editandoIndex = null;
    if (formulario) {
      (formulario as HTMLFormElement).reset();
    }
    vistaLista?.classList.add('hidden');
    vistaFormulario?.classList.remove('hidden');
  });

  btnRegresar?.addEventListener('click', () => {
    editandoIndex = null;
    vistaFormulario?.classList.add('hidden');
    vistaLista?.classList.remove('hidden');
    if (formulario) {
      (formulario as HTMLFormElement).reset();
    }
  });

  formulario?.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target as HTMLFormElement);
    const participacion = {
      organismo: formData.get('organismo') as string,
      periodo: formData.get('periodo') as string,
      nivelParticipacion: formData.get('nivel') as string,
      documento: formData.get('documento') as File | null
    };

    if (editandoIndex !== null) {
      participaciones[editandoIndex] = participacion;
      editandoIndex = null;
    } else {
      participaciones.push(participacion);
    }

    renderizarTabla();
    vistaFormulario?.classList.add('hidden');
    vistaLista?.classList.remove('hidden');
    (e.target as HTMLFormElement).reset();
  });

  renderizarTabla();

  const email = localStorage.getItem('user_email');
  if (!email) {
    window.location.href = '/';
  } else {
    const headerEmailElement = document.querySelector('header p.text-sm.opacity-90');
    if (headerEmailElement) {
      headerEmailElement.textContent = email;
    }
  }
</script>
