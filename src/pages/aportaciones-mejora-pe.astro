---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Sidebar from '../components/Sidebar.astro';
---

<BaseLayout title="Aportaciones a la mejora del PE - SEDI">
  <Sidebar />

  <div class="flex flex-col min-h-screen bg-white">
    <Header showUserInfo={true} userEmail="" />

    <main class="flex-1 bg-[#f3f3f3] px-4 py-8 sm:px-8">
      <div id="vista-lista" class="max-w-[1728px] mx-auto bg-[#f3f3f3] rounded-[25px] shadow-[0px_4px_4px_0px_rgba(0,0,0,0.25)] p-6 sm:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div class="flex-1">
            <h1 class="text-[28px] sm:text-[32px] font-normal text-black mb-2 italic">
              Aportaciones relevantes para la mejora del PE
            </h1>
            <p class="text-[14px] text-gray-700 leading-snug">
              Participación del profesor en actividades relevantes del PE, tales como diseño del PE, diseño de asignatura(s) del PE, análisis de indicadores del PE, participación en cuerpos colegiados del PE, participación en grupos de mejora continua del PE, en actividades extracurriculares relacionadas con el PE, etc.
            </p>
          </div>
          <div class="flex gap-3">
            <button 
              id="btn-agregar"
              class="bg-[#1f6818] hover:bg-[#165012] text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200 whitespace-nowrap">
              Agregar
            </button>
            <a 
              href="/dashboard"
              class="bg-[#8b7355] hover:bg-[#7a6349] text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200 whitespace-nowrap">
              Regresar
            </a>
          </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-lg">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-[#d9d9d9]">
                <th class="border border-gray-400 px-4 py-3 text-left font-normal text-[20px] text-black">Descripción de la participación</th>
                <th class="border border-gray-400 px-4 py-3 text-center font-normal text-[20px] text-black">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-aportaciones">
              <tr>
                <td colspan="2" class="border border-gray-400 px-4 py-8 text-center text-gray-500">
                  No hay registros aún. Haz clic en "Agregar" para crear uno nuevo.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="vista-formulario" class="max-w-[1728px] mx-auto bg-[#f3f3f3] rounded-[25px] shadow-[0px_4px_4px_0px_rgba(0,0,0,0.25)] p-6 sm:p-8 hidden">
        <div class="flex justify-between items-center mb-8">
          <h1 class="text-[28px] sm:text-[32px] font-bold text-black text-center flex-1 italic uppercase">
            APORTACIONES RELEVANTES PARA LA MEJORA DEL PE
          </h1>
          <button 
            id="btn-regresar"
            class="bg-[#8b7355] hover:bg-[#7a6349] text-white font-semibold py-3 px-8 rounded-lg transition-colors duration-200 whitespace-nowrap">
            Regresar
          </button>
        </div>

        <form class="space-y-6 max-w-4xl mx-auto">
          <div class="flex flex-col gap-3">
            <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 mb-2">
              <p class="text-red-600 font-semibold text-center text-[16px]">
                *Describir en máximo 200 palabras su participación en actividades relevantes del PE*
              </p>
              <p class="text-sm text-gray-700 mt-2">
                En su descripción asegúrese de incluir cosas tales como: El diseño del PE, el diseño de asignatura(s) del PE, análisis de indicadores del PE, participación en cuerpos colegiados del PE, participación en grupos de mejora continua del PE, en actividades extracurriculares relacionadas con el PE, etc.
              </p>
            </div>
            
            <label for="descripcion" class="font-semibold text-black text-[18px]">
              Descripción de la participación del profesor en actividades relevantes
            </label>
            <textarea
              id="descripcion"
              name="descripcion"
              rows="14"
              required
              maxlength="1200"
              class="border-2 border-black rounded px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none bg-white"
              placeholder="Escriba aquí su descripción (máximo 200 palabras o 1200 caracteres)..."
            ></textarea>
            <p class="text-sm text-gray-600 text-right">
              <span id="word-count">0</span> palabras | <span id="char-count">0</span> / 1200 caracteres
            </p>
          </div>

          <div class="flex justify-center pt-4">
            <label for="documento" class="cursor-pointer bg-[#d9d9d9] hover:bg-[#c0c0c0] border-2 border-black rounded-lg px-8 py-4 inline-flex items-center transition-colors duration-200 font-semibold text-[18px]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              Subir documento
            </label>
            <input
              type="file"
              id="documento"
              name="documento"
              class="hidden"
            />
          </div>

          <div class="flex justify-center pt-6">
            <button
              type="submit"
              class="bg-[#0891b2] hover:bg-[#0e7490] text-white font-semibold py-3 px-16 rounded-lg transition-colors duration-200 text-[18px]">
              Guardar
            </button>
          </div>
        </form>
      </div>
    </main>

    <Footer />
  </div>
</BaseLayout>

<script>
  const vistaLista = document.getElementById('vista-lista');
  const vistaFormulario = document.getElementById('vista-formulario');
  const btnAgregar = document.getElementById('btn-agregar');
  const btnRegresar = document.getElementById('btn-regresar');
  const tablaAportaciones = document.getElementById('tabla-aportaciones');
  const formulario = document.querySelector('#vista-formulario form');
  const textarea = document.getElementById('descripcion') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count');
  const wordCount = document.getElementById('word-count');

  let aportaciones: any[] = [];
  let editandoIndex: number | null = null;

  function contarPalabras(texto: string): number {
    return texto.trim().split(/\s+/).filter(word => word.length > 0).length;
  }

  textarea?.addEventListener('input', () => {
    const texto = textarea.value;
    const palabras = contarPalabras(texto);
    const caracteres = texto.length;

    if (wordCount) wordCount.textContent = palabras.toString();
    if (charCount) charCount.textContent = caracteres.toString();

    if (palabras > 200) {
      if (wordCount) wordCount.classList.add('text-red-600', 'font-bold');
    } else {
      if (wordCount) wordCount.classList.remove('text-red-600', 'font-bold');
    }
  });

  function renderizarTabla() {
    if (!tablaAportaciones) return;

    if (aportaciones.length === 0) {
      tablaAportaciones.innerHTML = `
        <tr>
          <td colspan="2" class="border border-gray-400 px-4 py-8 text-center text-gray-500">
            No hay registros aún. Haz clic en "Agregar" para crear uno nuevo.
          </td>
        </tr>
      `;
    } else {
      tablaAportaciones.innerHTML = aportaciones.map((item, index) => {
        const descripcionCorta = item.descripcion.length > 150 
          ? item.descripcion.substring(0, 150) + '...' 
          : item.descripcion;
        
        return `
          <tr class="hover:bg-gray-50">
            <td class="border border-gray-400 px-4 py-3 text-black">${descripcionCorta}</td>
            <td class="border border-gray-400 px-4 py-3">
              <div class="flex justify-center items-center gap-3">
                <button class="btn-ver text-gray-600 hover:text-gray-800" data-index="${index}" title="Ver">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
                <button class="btn-editar text-gray-600 hover:text-gray-800" data-index="${index}" title="Editar">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button class="btn-eliminar text-red-600 hover:text-red-800" data-index="${index}" title="Eliminar">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      document.querySelectorAll('.btn-ver').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index') || '0');
          const item = aportaciones[index];
          const palabras = contarPalabras(item.descripcion);
          alert(`Descripción completa:\n\n${item.descripcion}\n\n(${palabras} palabras, ${item.descripcion.length} caracteres)`);
        });
      });

      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index') || '0');
          editandoIndex = index;
          const item = aportaciones[index];
          if (textarea) {
            textarea.value = item.descripcion;
            const palabras = contarPalabras(item.descripcion);
            const caracteres = item.descripcion.length;
            if (wordCount) wordCount.textContent = palabras.toString();
            if (charCount) charCount.textContent = caracteres.toString();
          }
          vistaLista?.classList.add('hidden');
          vistaFormulario?.classList.remove('hidden');
        });
      });

      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (confirm('¿Estás seguro de que deseas eliminar este registro?')) {
            const index = parseInt((e.currentTarget as HTMLElement).getAttribute('data-index') || '0');
            aportaciones.splice(index, 1);
            renderizarTabla();
          }
        });
      });
    }
  }

  btnAgregar?.addEventListener('click', () => {
    editandoIndex = null;
    if (formulario) {
      (formulario as HTMLFormElement).reset();
      if (wordCount) wordCount.textContent = '0';
      if (charCount) charCount.textContent = '0';
    }
    vistaLista?.classList.add('hidden');
    vistaFormulario?.classList.remove('hidden');
  });

  btnRegresar?.addEventListener('click', () => {
    editandoIndex = null;
    vistaFormulario?.classList.add('hidden');
    vistaLista?.classList.remove('hidden');
    if (formulario) {
      (formulario as HTMLFormElement).reset();
    }
  });

  formulario?.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target as HTMLFormElement);
    const descripcion = formData.get('descripcion') as string;
    const palabras = contarPalabras(descripcion);

    if (palabras > 200) {
      if (!confirm(`Tu descripción tiene ${palabras} palabras, que excede el límite de 200 palabras. ¿Deseas guardar de todos modos?`)) {
        return;
      }
    }

    const aportacion = {
      descripcion: descripcion,
      documento: formData.get('documento') as File | null
    };

    if (editandoIndex !== null) {
      aportaciones[editandoIndex] = aportacion;
      editandoIndex = null;
    } else {
      aportaciones.push(aportacion);
    }
    
    renderizarTabla();
    vistaFormulario?.classList.add('hidden');
    vistaLista?.classList.remove('hidden');
    (e.target as HTMLFormElement).reset();
  });

  renderizarTabla();

  const email = localStorage.getItem('user_email');
  if (!email) {
    window.location.href = '/';
  } else {
    const headerEmailElement = document.querySelector('header p.text-sm.opacity-90');
    if (headerEmailElement) {
      headerEmailElement.textContent = email;
    }
  }
</script>
